'use strict';

Object.defineProperty(exports, '__esModule', {
    value: true
});
exports.diff = diff;

var _patch = require('./patch');

var _utils = require('./utils');

/**
 * Get the difference between two dom nodes
 * @param a an Element Node
 * @param b an Element Node
 *
 * @return a patch object
 */

function diff(a, b) {

    if (a.isEqualNode(b)) return diffProperties(a, b).concat(diffChildren(a, b));

    if (a.tagName !== b.tagName) return [new _patch.Patch(_patch.Patch.REPLACE, a, b)];

    return diffAttributes(a, b).concat(diffProperties(a, b)).concat(diffChildren(a, b));
}

// diff node attributes
function diffAttributes(a, b) {

    var patches = [];

    var aAttrs = (0, _utils.getAttributes)(a);
    var bAttrs = (0, _utils.getAttributes)(b);

    Object.keys(aAttrs).forEach(function (attr) {

        if (attr in bAttrs) {

            patches.push(new _patch.Patch(_patch.Patch.CHANGEATTRIBUTE, a, attr, bAttrs[attr]));

            delete bAttrs[attr];
        } else {

            patches.push(new _patch.Patch(_patch.Patch.REMOVEATTRIBUTE, a, attr));
        }

        delete aAttrs[attr];
    });

    Object.keys(bAttrs).forEach(function (attr) {

        patches.push(new _patch.Patch(_patch.Patch.ADDATTRIBUTE, a, attr, bAttrs[attr]));
    });

    return patches;
}

var PROPS = ['value', 'selected', 'checked', 'data'];

// diff properties
function diffProperties(a, b) {

    var patches = [];

    PROPS.forEach(function (prop) {

        var aProp = a[prop];
        var bProp = b[prop];

        if (aProp !== bProp) patches.push(new _patch.Patch(_patch.Patch.CHANGEPROPERTY, a, prop, bProp));
    });

    return patches;
}

function diffChildren(a, b) {

    var patches = [];

    var aChilds = (0, _utils.getChildNodes)(a);
    var bChilds = (0, _utils.getChildNodes)(b);
    var aRemaining = [].concat(aChilds);
    var bRemaining = [].concat(bChilds);

    // elements with ids are special
    aChilds.forEach(function (aChild, aI) {

        if (aChild.id && b.querySelector) {

            var similar = b.querySelector('#' + aChild.id);

            if (similar) {

                var index = (0, _utils.getNodeIndex)(similar);

                patches = patches.concat(diff(aChild, similar));

                if (index !== aI) {
                    patches.push(new _patch.Patch(_patch.Patch.INSERT, a, aChild, index));
                }

                (0, _utils.without)(aRemaining, aChild);
                (0, _utils.without)(bRemaining, bChilds[index]);
            }
        }
    });

    aRemaining.forEach(function (aChild, aI) {

        var bChild = bRemaining[aI];

        if (bChild === undefined) return patches.push(new _patch.Patch(_patch.Patch.REMOVE, aChild));

        patches = patches.concat(diff(aChild, bChild));

        (0, _utils.without)(bRemaining, bChild);
    });

    bRemaining.forEach(function (bChild) {

        patches.push(new _patch.Patch(_patch.Patch.INSERT, a, bChild, -1));
    });

    return patches;
}
//# sourceMappingURL=data:application/json;base64,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MUQ7O0FBRUQsMkJBeEdtQyxPQUFPLEVBd0dsQyxVQUFVLEVBQUUsTUFBTSxDQUFDLENBQUM7QUFDNUIsMkJBekdtQyxPQUFPLEVBeUdsQyxVQUFVLEVBQUUsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7YUFDdkM7U0FDSjtLQUVKLENBQUMsQ0FBQzs7QUFFSCxjQUFVLENBQUMsT0FBTyxDQUFDLFVBQVMsTUFBTSxFQUFFLEVBQUUsRUFBQzs7QUFFbkMsWUFBSSxNQUFNLEdBQUcsVUFBVSxDQUFDLEVBQUUsQ0FBQyxDQUFDOztBQUU1QixZQUFHLE1BQU0sS0FBSyxTQUFTLEVBQ25CLE9BQU8sT0FBTyxDQUFDLElBQUksQ0FBQyxXQXJIeEIsS0FBSyxDQXFINkIsT0FySGxDLEtBQUssQ0FxSG1DLE1BQU0sRUFBRSxNQUFNLENBQUMsQ0FBQyxDQUFDOztBQUV6RCxlQUFPLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUM7O0FBRS9DLG1CQXhIMkMsT0FBTyxFQXdIMUMsVUFBVSxFQUFFLE1BQU0sQ0FBQyxDQUFDO0tBQy9CLENBQUMsQ0FBQzs7QUFFSCxjQUFVLENBQUMsT0FBTyxDQUFDLFVBQVMsTUFBTSxFQUFDOztBQUUvQixlQUFPLENBQUMsSUFBSSxDQUFDLFdBOUhiLEtBQUssQ0E4SGtCLE9BOUh2QixLQUFLLENBOEh3QixNQUFNLEVBQUUsQ0FBQyxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7S0FDeEQsQ0FBQyxDQUFDOztBQUVILFdBQU8sT0FBTyxDQUFDO0NBQ2xCIiwiZmlsZSI6ImRpZmYuanMiLCJzb3VyY2VzQ29udGVudCI6WyJcbmltcG9ydCB7UGF0Y2h9IGZyb20gJy4vcGF0Y2gnO1xuaW1wb3J0IHtnZXRDaGlsZE5vZGVzLGdldEF0dHJpYnV0ZXMsIGdldE5vZGVJbmRleCwgd2l0aG91dH0gZnJvbSAnLi91dGlscyc7XG5cblxuLyoqXG4gKiBHZXQgdGhlIGRpZmZlcmVuY2UgYmV0d2VlbiB0d28gZG9tIG5vZGVzXG4gKiBAcGFyYW0gYSBhbiBFbGVtZW50IE5vZGVcbiAqIEBwYXJhbSBiIGFuIEVsZW1lbnQgTm9kZVxuICpcbiAqIEByZXR1cm4gYSBwYXRjaCBvYmplY3RcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGRpZmYoYSxiKXtcblxuICAgIGlmKGEuaXNFcXVhbE5vZGUoYikpXG4gICAgICAgIHJldHVybiBkaWZmUHJvcGVydGllcyhhLGIpLmNvbmNhdChkaWZmQ2hpbGRyZW4oYSxiKSk7XG5cbiAgICBpZihhLnRhZ05hbWUgIT09IGIudGFnTmFtZSlcbiAgICAgICAgcmV0dXJuIFtuZXcgUGF0Y2goUGF0Y2guUkVQTEFDRSwgYSwgYildO1xuXG5cbiAgICByZXR1cm4gZGlmZkF0dHJpYnV0ZXMoYSxiKS5jb25jYXQoZGlmZlByb3BlcnRpZXMoYSxiKSkuY29uY2F0KGRpZmZDaGlsZHJlbihhLGIpKTtcbn1cblxuXG4vLyBkaWZmIG5vZGUgYXR0cmlidXRlc1xuZnVuY3Rpb24gZGlmZkF0dHJpYnV0ZXMoYSwgYil7XG5cbiAgICBsZXQgcGF0Y2hlcyA9IFtdO1xuXG4gICAgbGV0IGFBdHRycyA9IGdldEF0dHJpYnV0ZXMoYSk7XG4gICAgbGV0IGJBdHRycyA9IGdldEF0dHJpYnV0ZXMoYik7XG5cblxuICAgIE9iamVjdC5rZXlzKGFBdHRycykuZm9yRWFjaChmdW5jdGlvbihhdHRyKXtcblxuICAgICAgICBpZihhdHRyIGluIGJBdHRycyl7XG5cbiAgICAgICAgICAgIHBhdGNoZXMucHVzaChuZXcgUGF0Y2goUGF0Y2guQ0hBTkdFQVRUUklCVVRFLCBhLCBhdHRyLCBiQXR0cnNbYXR0cl0pKTtcblxuICAgICAgICAgICAgZGVsZXRlIGJBdHRyc1thdHRyXTtcblxuICAgICAgICB9IGVsc2V7XG5cbiAgICAgICAgICAgIHBhdGNoZXMucHVzaChuZXcgUGF0Y2goUGF0Y2guUkVNT1ZFQVRUUklCVVRFLCBhLCBhdHRyKSk7XG4gICAgICAgIH1cblxuICAgICAgICBkZWxldGUgYUF0dHJzW2F0dHJdO1xuICAgIH0pO1xuXG4gICAgT2JqZWN0LmtleXMoYkF0dHJzKS5mb3JFYWNoKGZ1bmN0aW9uKGF0dHIpe1xuXG4gICAgICAgIHBhdGNoZXMucHVzaChuZXcgUGF0Y2goUGF0Y2guQUREQVRUUklCVVRFLCBhLCBhdHRyLCBiQXR0cnNbYXR0cl0pKVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHBhdGNoZXM7XG59XG5cblxuY29uc3QgUFJPUFMgPSBbJ3ZhbHVlJywgJ3NlbGVjdGVkJywgJ2NoZWNrZWQnLCAnZGF0YSddO1xuXG4vLyBkaWZmIHByb3BlcnRpZXNcbmZ1bmN0aW9uIGRpZmZQcm9wZXJ0aWVzKGEsIGIpe1xuXG4gICAgbGV0IHBhdGNoZXMgPSBbXTtcblxuICAgIFBST1BTLmZvckVhY2goZnVuY3Rpb24ocHJvcCl7XG5cbiAgICAgICAgbGV0IGFQcm9wID0gYVtwcm9wXTtcbiAgICAgICAgbGV0IGJQcm9wID0gYltwcm9wXTtcblxuICAgICAgICBpZihhUHJvcCAhPT0gYlByb3ApXG4gICAgICAgICAgICBwYXRjaGVzLnB1c2gobmV3IFBhdGNoKFBhdGNoLkNIQU5HRVBST1BFUlRZLCBhLCBwcm9wLCBiUHJvcCkpO1xuXG4gICAgfSk7XG5cbiAgICByZXR1cm4gcGF0Y2hlcztcbn1cblxuXG5mdW5jdGlvbiBkaWZmQ2hpbGRyZW4oYSwgYil7XG5cbiAgICBsZXQgcGF0Y2hlcyA9IFtdO1xuXG4gICAgbGV0IGFDaGlsZHMgPSBnZXRDaGlsZE5vZGVzKGEpO1xuICAgIGxldCBiQ2hpbGRzID0gZ2V0Q2hpbGROb2RlcyhiKTtcbiAgICBsZXQgYVJlbWFpbmluZyA9IFtdLmNvbmNhdChhQ2hpbGRzKTtcbiAgICBsZXQgYlJlbWFpbmluZyA9IFtdLmNvbmNhdChiQ2hpbGRzKTtcblxuICAgIC8vIGVsZW1lbnRzIHdpdGggaWRzIGFyZSBzcGVjaWFsXG4gICAgYUNoaWxkcy5mb3JFYWNoKGZ1bmN0aW9uKGFDaGlsZCAsYUkpe1xuXG4gICAgICAgIGlmKGFDaGlsZC5pZCAmJiBiLnF1ZXJ5U2VsZWN0b3Ipe1xuXG4gICAgICAgICAgICBsZXQgc2ltaWxhciA9IGIucXVlcnlTZWxlY3RvcignIycrYUNoaWxkLmlkKTtcblxuICAgICAgICAgICAgaWYoc2ltaWxhcikge1xuXG4gICAgICAgICAgICAgICAgbGV0IGluZGV4ID0gZ2V0Tm9kZUluZGV4KHNpbWlsYXIpO1xuXG4gICAgICAgICAgICAgICAgcGF0Y2hlcyA9IHBhdGNoZXMuY29uY2F0KGRpZmYoYUNoaWxkLCBzaW1pbGFyKSk7XG5cbiAgICAgICAgICAgICAgICBpZiAoaW5kZXggIT09IGFJKSB7XG4gICAgICAgICAgICAgICAgICAgIHBhdGNoZXMucHVzaChuZXcgUGF0Y2goUGF0Y2guSU5TRVJULCBhLCBhQ2hpbGQsIGluZGV4KSlcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICB3aXRob3V0KGFSZW1haW5pbmcsIGFDaGlsZCk7XG4gICAgICAgICAgICAgICAgd2l0aG91dChiUmVtYWluaW5nLCBiQ2hpbGRzW2luZGV4XSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgIH0pO1xuXG4gICAgYVJlbWFpbmluZy5mb3JFYWNoKGZ1bmN0aW9uKGFDaGlsZCAsYUkpe1xuXG4gICAgICAgIGxldCBiQ2hpbGQgPSBiUmVtYWluaW5nW2FJXTtcblxuICAgICAgICBpZihiQ2hpbGQgPT09IHVuZGVmaW5lZClcbiAgICAgICAgICAgIHJldHVybiBwYXRjaGVzLnB1c2gobmV3IFBhdGNoKFBhdGNoLlJFTU9WRSwgYUNoaWxkKSk7XG5cbiAgICAgICAgcGF0Y2hlcyA9IHBhdGNoZXMuY29uY2F0KGRpZmYoYUNoaWxkLCBiQ2hpbGQpKTtcblxuICAgICAgICB3aXRob3V0KGJSZW1haW5pbmcsIGJDaGlsZCk7XG4gICAgfSk7XG5cbiAgICBiUmVtYWluaW5nLmZvckVhY2goZnVuY3Rpb24oYkNoaWxkKXtcblxuICAgICAgICBwYXRjaGVzLnB1c2gobmV3IFBhdGNoKFBhdGNoLklOU0VSVCwgYSwgYkNoaWxkLCAtMSkpO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIHBhdGNoZXM7XG59Il19